<h2>ğŸ® Productos en Tiempo Real</h2>

<form id="productForm">
    <input type="text" name="title" placeholder="ğŸ¯ TÃ­tulo del producto" required>
    <input type="text" name="description" placeholder="ğŸ“ DescripciÃ³n" required>
    <input type="number" name="price" placeholder="ğŸ’° Precio" required min="0" step="0.01">
    <input type="text" name="code" placeholder="ğŸ”– CÃ³digo Ãºnico" required>
    <input type="number" name="stock" placeholder="ğŸ“¦ Stock disponible" required min="0">
    <input type="text" name="category" placeholder="ğŸ·ï¸ CategorÃ­a" required>
    <button type="submit">ğŸš€ Agregar Producto</button>
</form>

<div id="productsList" class="products-container">
    {{#each products}}
    <div class="product-card" id="product-{{this.id}}">
        <h3>{{this.title}}</h3>
        <p>ğŸ“ {{this.description}}</p>
        <p>ğŸ’° Precio: ${{this.price}}</p>
        <p>ğŸ“¦ Stock: {{this.stock}} unidades</p>
        <p>ğŸ”– CÃ³digo: {{this.code}}</p>
        <p>ğŸ·ï¸ CategorÃ­a: {{this.category}}</p>
        <button onclick="deleteProduct({{this.id}})">ğŸ—‘ï¸ Eliminar Producto</button>
    </div>
    {{else}}
    <p>ğŸ˜´ No hay productos disponibles. Â¡Agrega el primero!</p>
    {{/each}}
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const socket = io();
    
    function showAlert(title, message, icon = 'success') {
        Swal.fire({
            title: title,
            text: message,
            icon: icon,
            position: 'top-end',
            toast: true,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            background: '#1a1a1a',
            color: 'white',
            iconColor: icon === 'success' ? '#4ade80' : '#f87171'
        });
    }

    socket.on('updateProducts', (products) => {
        console.log('Productos actualizados:', products);
        const productsList = document.getElementById('productsList');
        
        if (products && products.length > 0) {
            productsList.innerHTML = products.map(product => `
                <div class="product-card" id="product-${product.id}">
                    <h3>${product.title}</h3>
                    <p>ğŸ“ ${product.description}</p>
                    <p>ğŸ’° Precio: $${product.price}</p>
                    <p>ğŸ“¦ Stock: ${product.stock} unidades</p>
                    <p>ğŸ”– CÃ³digo: ${product.code}</p>
                    <p>ğŸ·ï¸ CategorÃ­a: ${product.category}</p>
                    <button onclick="deleteProduct(${product.id})">ğŸ—‘ï¸ Eliminar Producto</button>
                </div>
            `).join('');
        } else {
            productsList.innerHTML = '<p>ğŸ˜´ No hay productos disponibles. Â¡Agrega el primero!</p>';
        }
    });
    
    socket.on('productSuccess', (message) => {
        showAlert('Â¡Ã‰xito!', message, 'success');
    });
    
    socket.on('productError', (message) => {
        showAlert('Error', message, 'error');
    });
    
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const product = Object.fromEntries(formData);
        
        for (const key in product) {
            if (!product[key].trim()) {
                showAlert('Error', 'Todos los campos son obligatorios', 'error');
                return;
            }
        }
        
        if (isNaN(product.price) || parseFloat(product.price) <= 0) {
            showAlert('Error', 'El precio debe ser un nÃºmero vÃ¡lido mayor a 0', 'error');
            return;
        }
        
        if (isNaN(product.stock) || parseInt(product.stock) < 0) {
            showAlert('Error', 'El stock debe ser un nÃºmero vÃ¡lido mayor o igual a 0', 'error');
            return;
        }
  
        const { isConfirmed } = await Swal.fire({
            title: 'Â¿Agregar producto?',
            text: 'Â¿EstÃ¡s seguro de que quieres agregar este producto?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'SÃ­, agregar',
            cancelButtonText: 'Cancelar'
        });
        
        if (isConfirmed) {
            socket.emit('newProduct', product);
            e.target.reset();
        }
    });
    
    window.deleteProduct = async (id) => {
        const { isConfirmed } = await Swal.fire({
            title: 'Â¿Eliminar producto?',
            text: 'Esta acciÃ³n no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'SÃ­, eliminar',
            cancelButtonText: 'Cancelar',
            background: '#1a1a1a',
            color: 'white'
        });
        
        if (isConfirmed) {
            socket.emit('deleteProduct', id);
        }
    };
    
    socket.on('connect_error', (error) => {
        showAlert('Error de conexiÃ³n', 'No se pudo conectar al servidor', 'error');
    });
    
    socket.on('disconnect', () => {
        showAlert('Desconectado', 'Se perdiÃ³ la conexiÃ³n con el servidor', 'warning');
    });
</script>