<div class="container main-content fade-in">
  <h1 class="page-title">ğŸ“¦ Nuestros Productos</h1>

  <div class="filters-section">
    <form action="/products" method="GET" class="filters-grid">
      <div class="filter-group">
        <label class="form-label">ğŸ” Buscar:</label>
        <input type="text" name="query" value="{{query.query}}" 
               placeholder="CategorÃ­a, nombre..." class="form-control">
      </div>
      
      <div class="filter-group">
        <label class="form-label">ğŸ“Š Ordenar por precio:</label>
        <select name="sort" class="form-select">
          <option value="">Sin orden</option>
          <option value="asc" {{#eq query.sort 'asc'}}selected{{/eq}}>Menor a Mayor</option>
          <option value="desc" {{#eq query.sort 'desc'}}selected{{/eq}}>Mayor a Menor</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="form-label">ğŸ“„ Productos por pÃ¡gina:</label>
        <select name="limit" class="form-select">
          <option value="5" {{#eq query.limit '5'}}selected{{/eq}}>5</option>
          <option value="10" {{#eq query.limit '10'}}selected{{/eq}}>10</option>
          <option value="20" {{#eq query.limit '20'}}selected{{/eq}}>20</option>
        </select>
      </div>

      <button type="submit" class="btn btn-success">Aplicar Filtros</button>
    </form>
  </div>

  {{#if payload.length}}
    <div class="products-grid">
      {{#each payload}}
        <div class="product-card">
          <h3>{{this.title}}</h3>
          <p class="product-price">ğŸ’° ${{this.price}}</p>
          <p><strong>ğŸ“¦ Stock:</strong> {{this.stock}} unidades</p>
          <p><strong>ğŸ·ï¸ CategorÃ­a:</strong> {{this.category}}</p>
          <p><strong>ğŸ“ DescripciÃ³n:</strong> {{this.description}}</p>
          
          <div class="product-actions">
            <a href="/products/{{this._id}}" class="btn btn-primary">ğŸ‘ï¸ Ver Detalles</a>
            <button onclick="addToCart('{{this._id}}')" 
                    class="btn btn-success" 
                    {{#unless this.stock}}disabled{{/unless}}>
              ğŸ›’ Agregar
            </button>
          </div>
        </div>
      {{/each}}
    </div>

    {{#if totalPages}}
      <div class="pagination">
        {{#if hasPrevPage}}
          <a href="{{prevLink}}" class="page-link">Â« Anterior</a>
        {{else}}
          <span class="page-link disabled">Â« Anterior</span>
        {{/if}}

        <span class="page-info">PÃ¡gina {{page}} de {{totalPages}}</span>

        {{#if hasNextPage}}
          <a href="{{nextLink}}" class="page-link">Siguiente Â»</a>
        {{else}}
          <span class="page-link disabled">Siguiente Â»</span>
        {{/if}}
      </div>
    {{/if}}

  {{else}}
    <div class="empty-state">
      <h3>ğŸ˜” No se encontraron productos</h3>
      <p class="text-muted">Intenta con otros filtros de bÃºsqueda</p>
      <a href="/products" class="btn btn-secondary">Limpiar Filtros</a>
    </div>
  {{/if}}
</div>

<script>
async function addToCart(productId) {
  try {
    Swal.fire({
      title: 'Agregando producto...',
      text: 'Por favor espere',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    let cartId = localStorage.getItem('currentCartId');
    
    if (!cartId) {
      const response = await fetch('/api/carts', { 
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) throw new Error('Error creando carrito');
      
      const data = await response.json();
      cartId = data.cart._id;
      localStorage.setItem('currentCartId', cartId);
    }

    const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    const result = await response.json();

    if (response.ok && result.success) {
      Swal.fire({
        icon: 'success',
        title: 'Â¡Producto agregado!',
        text: 'El producto se agregÃ³ correctamente al carrito',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      throw new Error(result.error || 'Error al agregar producto');
    }

  } catch (error) {
    console.error('Error:', error);
    
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: error.message || 'No se pudo agregar el producto al carrito',
      confirmButtonText: 'Entendido'
    });
  }
}
</script>